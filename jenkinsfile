def ecr_repository_url
def ecr_username
def ecr_password

pipeline {
  agent none

  environment {
    AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
    AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
  }

  stages {
    stage('Prepare Infrastructure') {
      agent { 
        label 'terraform'
      }
      steps {
        sh 'cd terraform'
        sh 'terraform init'
        sh 'terraform apply -auto-approve'
        sh "terraform output ecr_repository_url | tr -d '" + '"' + "' > ecr_repository_url.txt"
        sh "terraform output ecr_username | tr -d '" + '"' + "' > ecr_username.txt"
        sh "terraform output ecr_password | tr -d '" + '"' + "' > ecr_password.txt"
        script {
          ecr_repository_url = readFile('ecr_repository_url.txt').trim()
          ecr_username = readFile('ecr_username.txt').trim()
          ecr_password = readFile('ecr_password.txt').trim()
        }
        sh 'rm -rf ecr_*.txt'
      }
    }

    stage('Build Image') {
      agent { 
        label 'docker'
      }
      steps {
        sh " echo ${ecr_password} | docker login --username ${ecr_username} --password-stdin ${ecr_repository_url}"
        sh "docker build -t ${ecr_repository_url}/pokedex:latest ."
        sh "docker push ${ecr_repository_url}/pokedex:latest"
        sh 'docker logout'
      }
    }

    stage('Deploy') {
      steps {
        echo 'Deploying....'
      }
    }
  }
}